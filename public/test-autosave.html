<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-token">
    <title>Тест автосохранения</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <div class="container-fluid p-4">
        <h1>Тест системы автосохранения</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Редактор сметы (симуляция)</h5>
                    </div>
                    <div class="card-body">
                        <form id="estimateForm">
                            <div id="estimate-editor">
                                <div class="section mb-4" data-section-id="demo_1">
                                    <h6>Демонтажные работы</h6>
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" name="data[sections][demo_1][items][row1][name]" value="Демонтаж старых обоев" placeholder="Название работы">
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" name="data[sections][demo_1][items][row1][unit]">
                                                <option value="м²">м²</option>
                                                <option value="шт">шт</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="data[sections][demo_1][items][row1][quantity]" value="20" step="0.01">
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="data[sections][demo_1][items][row1][price]" value="150" step="0.01">
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="data[sections][demo_1][items][row1][markup]" value="20" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="section mb-4" data-section-id="walls_1">
                                    <h6>Стены</h6>
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" name="data[sections][walls_1][items][row2][name]" value="Поклейка обоев" placeholder="Название работы">
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" name="data[sections][walls_1][items][row2][unit]">
                                                <option value="м²" selected>м²</option>
                                                <option value="шт">шт</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="data[sections][walls_1][items][row2][quantity]" value="25" step="0.01">
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="data[sections][walls_1][items][row2][price]" value="350" step="0.01">
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control" name="data[sections][walls_1][items][row2][markup]" value="25" step="0.01">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <input type="hidden" id="work_total" name="data[totals][work_total]" value="0">
                                <input type="hidden" id="materials_total" name="data[totals][materials_total]" value="0">
                                <input type="hidden" id="grand_total" name="data[totals][grand_total]" value="0">
                                <input type="number" id="markup_percent" name="data[totals][markup_percent]" class="form-control" value="20" placeholder="Общая наценка %">
                                <input type="number" id="discount_percent" name="data[totals][discount_percent]" class="form-control" value="0" placeholder="Общая скидка %">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Управление автосохранением</h5>
                    </div>
                    <div class="card-body">
                        <div class="btn-group d-flex mb-3">
                            <button class="btn btn-success" onclick="startAutosave()">Запустить</button>
                            <button class="btn btn-warning" onclick="pauseAutosave()">Пауза</button>
                            <button class="btn btn-primary" onclick="forceSave()">Сохранить сейчас</button>
                            <button class="btn btn-danger" onclick="stopAutosave()">Остановить</button>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6>Инструкция:</h6>
                            <ul class="mb-0">
                                <li>Измените любые поля в форме</li>
                                <li>Автосохранение сработает через 15 секунд</li>
                                <li>Статус отображается в правом верхнем углу</li>
                                <li>Можете принудительно сохранить или управлять процессом</li>
                            </ul>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Лог событий:</h6>
                            <div id="eventLog" class="border p-2" style="height: 200px; overflow-y: auto; font-size: 0.8rem;">
                                <div class="text-muted">Логи автосохранения будут отображаться здесь...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/estimate-autosave.js"></script>
    <script>
        let autosaveInstance = null;
        
        function startAutosave() {
            if (autosaveInstance) {
                autosaveInstance.destroy();
            }
            
            autosaveInstance = new EstimateAutosave(14, {
                interval: 5000, // 5 секунд для тестирования
                enableDebug: true,
                maxRetries: 3,
                retryDelay: 1000
            });
            
            logEvent('Автосохранение запущено');
        }
        
        function pauseAutosave() {
            if (autosaveInstance) {
                autosaveInstance.pause();
                logEvent('Автосохранение приостановлено');
            }
        }
        
        function forceSave() {
            if (autosaveInstance) {
                autosaveInstance.forceSave();
                logEvent('Принудительное сохранение');
            }
        }
        
        function stopAutosave() {
            if (autosaveInstance) {
                autosaveInstance.destroy();
                autosaveInstance = null;
                logEvent('Автосохранение остановлено');
            }
        }
        
        function logEvent(message) {
            const log = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        // Автоматический запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            startAutosave();
        });
        
        // Переопределяем метод sendSaveRequest для тестирования
        EstimateAutosave.prototype.sendSaveRequest = async function(data) {
            logEvent('Отправка данных: ' + JSON.stringify(data, null, 2).substring(0, 100) + '...');
            
            // Симуляция запроса
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Симуляция успешного ответа
            return {
                success: true,
                message: 'Тестовое сохранение выполнено',
                timestamp: new Date().toLocaleTimeString()
            };
        };
    </script>
</body>
</html>
